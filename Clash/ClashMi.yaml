// è„šæœ¬åˆ†äº«åœ°å€ï¼šhttps://linux.do/t/topic/471428/143?u=oojialin
/**
 * ClashVerge ä»£ç†è§„åˆ™é…ç½®ç”Ÿæˆè„šæœ¬
 * MIT License ~
 * author : Phantasia https://github.com/MarchPhantasia
 */
// ==================== ç”¨æˆ·é…ç½®åŒºï¼ˆå¯è‡ªç”±ä¿®æ”¹ï¼‰ ====================
/**
 * å¸¸ç”¨é…ç½®é€‰é¡¹
 */
const CONFIG = {
    // æµ‹è¯•è¿æ¥URL
    testUrl: "https://www.gstatic.com/generate_204", // ç”¨äºæµ‹è¯•ä»£ç†æœåŠ¡å™¨è¿é€šæ€§çš„URLï¼Œé€šå¸¸è¿”å›HTTP 204çŠ¶æ€ç 
    // è‡ªåŠ¨æµ‹è¯•é—´éš” (ç§’)
    testInterval: 300, // è‡ªåŠ¨æµ‹è¯•ä»£ç†æœåŠ¡å™¨å»¶è¿Ÿçš„é—´éš”æ—¶é—´ï¼Œå•ä½ä¸ºç§’
    // è‡ªåŠ¨é€‰ä¼˜å®¹å·® (æ¯«ç§’)
    tolerance: 20, // è‡ªåŠ¨é€‰ä¼˜ä»£ç†æœåŠ¡å™¨æ—¶ï¼Œå…è®¸çš„å»¶è¿Ÿå·®å¼‚èŒƒå›´ï¼Œå•ä½ä¸ºæ¯«ç§’
    // è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š"round-robin" | "sticky-sessions" | "consistent-hashing"
    // round-robinï¼šè½®è¯¢ï¼Œå°†ä¼šæŠŠæ‰€æœ‰çš„è¯·æ±‚åˆ†é…ç»™ç­–ç•¥ç»„å†…ä¸åŒçš„ä»£ç†èŠ‚ç‚¹
    // consistent-hashingï¼šæ•£åˆ—ï¼Œå°†ç›¸åŒçš„ ç›®æ ‡åœ°å€ çš„è¯·æ±‚åˆ†é…ç»™ç­–ç•¥ç»„å†…çš„åŒä¸€ä¸ªä»£ç†èŠ‚ç‚¹
    // sticky-sessionsï¼šç¼“å­˜ï¼Œå°†ç›¸åŒçš„ æ¥æºåœ°å€ å’Œ ç›®æ ‡åœ°å€ çš„è¯·æ±‚åˆ†é…ç»™ç­–ç•¥ç»„å†…çš„åŒä¸€ä¸ªä»£ç†èŠ‚ç‚¹ï¼Œç¼“å­˜ 10 åˆ†é’Ÿè¿‡æœŸ
    balanceStrategy: "sticky-sessions" // è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œç”¨äºåœ¨å¤šä¸ªä»£ç†æœåŠ¡å™¨ä¹‹é—´åˆ†é…æµé‡
};

/**
 * ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
 * è¿™äº›è§„åˆ™ä¼šè¢«æ”¾ç½®åœ¨æ‰€æœ‰å…¶ä»–è§„åˆ™ä¹‹å‰ï¼Œç¡®ä¿ä¸ä¼šè¢«å…¶ä»–è§„åˆ™è¦†ç›–
 */
const USER_RULES = [
    "DOMAIN-SUFFIX,v2ex.com,Outside", // åŒ¹é…v2ex.comåŠå…¶å­åŸŸåï¼Œå¹¶æ ‡è®°ä¸ºâ€œOutsideâ€
    "DOMAIN-SUFFIX,nodeseek.com,Outside", // åŒ¹é…nodeseek.comåŠå…¶å­åŸŸåï¼Œå¹¶æ ‡è®°ä¸ºâ€œOutsideâ€
    "DOMAIN-SUFFIX,mnapi.com,DIRECT",    // åŒ¹é…mnapi.comåŠå…¶å­åŸŸåï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰
    "DOMAIN-SUFFIX,ieee.org,DIRECT",    // åŒ¹é…ieee.orgåŠå…¶å­åŸŸåï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰
    "DOMAIN-SUFFIX,anrunnetwork.com,DIRECT",    // åŒ¹é…anrunnetwork.comåŠå…¶å­åŸŸåï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰
    "DOMAIN-SUFFIX,apifox.com,DIRECT",    // åŒ¹é…apifox.comåŠå…¶å­åŸŸåï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰
    "DOMAIN-SUFFIX,crond.dev,DIRECT",    // åŒ¹é…crond.devåŠå…¶å­åŸŸåï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰
    "IP-CIDR,223.113.52.0/22,DIRECT,no-resolve" // åŒ¹é…IPåœ°å€æ®µ223.113.52.0/22ï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰ï¼Œä¸è¿›è¡ŒåŸŸåè§£æ
    // åœ¨æ­¤æ·»åŠ æ›´å¤šè‡ªå®šä¹‰è§„åˆ™...
];

const SAVED_RULES = [
    "RULE-SET,reject,Ads",       // åŒ¹é…â€œå¹¿å‘Šæ‹¦æˆªâ€è§„åˆ™é›†ï¼Œå¹¶ä½¿ç”¨REJECTç­–ç•¥ï¼ˆæ‹’ç»è¿æ¥ï¼‰
    "RULE-SET,cncidr,DIRECT,no-resolve", // åŒ¹é…â€œcncidrâ€è§„åˆ™é›†ï¼ˆä¸­å›½å¤§é™†IPæ®µï¼‰ï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰ï¼Œä¸è¿›è¡ŒåŸŸåè§£æ
    "RULE-SET,direct,DIRECT",       // åŒ¹é…â€œdirectâ€è§„åˆ™é›†ï¼Œå¹¶ä½¿ç”¨DIRECTç­–ç•¥ï¼ˆç›´è¿ï¼‰
    "GEOSITE,gfw,Outside",         // åŒ¹é…è¢«å¢™ç½‘ç«™ï¼Œå¹¶æ ‡è®°ä¸ºâ€œOutsideâ€
    "GEOIP,CN,China",           // åŒ¹é…ä¸­å›½å¤§é™†IPåœ°å€ï¼Œå¹¶æ ‡è®°ä¸ºâ€œå›½å†…ç½‘ç«™â€
    "MATCH,World"             // åŒ¹é…æ‰€æœ‰å…¶ä»–æµé‡ï¼Œå¹¶æ ‡è®°ä¸ºâ€œå›½å¤–ç½‘ç«™â€
];

/**
 * åœ°åŒºåˆ†ç»„é…ç½®
 * ç”¨äºæŒ‰çº¿è·¯æ‰€åœ¨åœ°åŒºåˆ†ç»„
 * æ·»åŠ äº†ä¸€ä¸ªenabledå¼€å…³ï¼Œç”¨äºæ§åˆ¶æ˜¯å¦å¯ç”¨è¯¥åœ°åŒºåˆ†ç»„
 */
const REGIONS = [
    {
        name: "HK",
        keywords: ["é¦™æ¸¯", "æ¸¯", "ğŸ‡­ğŸ‡°", "hk", "hongkong", "hong kong"],
        icon: "https://flagicons.lipis.dev/flags/4x3/hk.svg",
        enabled: true // true è¡¨ç¤ºå¯ç”¨è¯¥åˆ†ç»„ï¼Œfalse è¡¨ç¤ºç¦ç”¨
    },
    {
        name: "TW",
        keywords: ["å°æ¹¾", "æ¹¾", "ğŸ‡¹ğŸ‡¼", "tw", "taiwan", "tai wan"],
        icon: "https://flagicons.lipis.dev/flags/4x3/tw.svg",
        enabled: true
    },
    {
        name: "JP",
        keywords: ["æ—¥æœ¬", "ğŸ‡¯ğŸ‡µ", "jp", "japan", "c7s4"],
        icon: "https://flagicons.lipis.dev/flags/4x3/jp.svg",
        enabled: true
    },
    {
        name: "KR",
        keywords: ["éŸ©å›½", "ğŸ‡°ğŸ‡·", "kr", "Korea"],
        icon: "https://flagicons.lipis.dev/flags/4x3/kr.svg",
        enabled: true
    },	
    {
        name: "SG",
        keywords: ["æ–°åŠ å¡", "ç‹®åŸ", "ğŸ‡¸ğŸ‡¬", "sg", "singapore"],
        icon: "https://flagicons.lipis.dev/flags/4x3/sg.svg",
        enabled: true
    },
    {
        name: "US",
        keywords: ["ç¾å›½", "US", "ğŸ‡ºğŸ‡¸", "USA", "United States", "c7s1", "c7s2", "c7s3"],
        icon: "https://flagicons.lipis.dev/flags/4x3/us.svg",
        enabled: true
    },	
    {
        name: "è¶Šå—",
        keywords: ["è¶Šå—", "VN", "Vietnam", "ğŸ‡»ğŸ‡³"],
        icon: "https://flagicons.lipis.dev/flags/4x3/vn.svg",
        enabled: false
    },
    {
        name: "æ³°å›½",
        keywords: ["æ³°å›½", "TH", "Thailand", "ğŸ‡¹ğŸ‡­"],
        icon: "https://flagicons.lipis.dev/flags/4x3/th.svg",
        enabled: false
    },
    {
        name: "è²å¾‹å®¾",
        keywords: ["è²å¾‹å®¾", "PH", "Philippines", "ğŸ‡µğŸ‡­"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ph.svg",
        enabled: false
    },
    {
        name: "é©¬æ¥è¥¿äºš",
        keywords: ["é©¬æ¥è¥¿äºš", "MY", "Malaysia", "ğŸ‡²ğŸ‡¾"],
        icon: "https://flagicons.lipis.dev/flags/4x3/my.svg",
        enabled: false
    },
    {
        name: "æŸ¬åŸ”å¯¨",
        keywords: ["æŸ¬åŸ”å¯¨", "KH", "Cambodia", "ğŸ‡°ğŸ‡­"],
        icon: "https://flagicons.lipis.dev/flags/4x3/kh.svg",
        enabled: false
    },
    {
        name: "å°åº¦å°¼è¥¿äºš",
        keywords: ["å°åº¦å°¼è¥¿äºš", "ID", "Indonesia", "ğŸ‡®ğŸ‡©"],
        icon: "https://flagicons.lipis.dev/flags/4x3/id.svg",
        enabled: false
    },
    {
        name: "ç¼…ç”¸",
        keywords: ["ç¼…ç”¸", "MM", "Myanmar", "ğŸ‡²ğŸ‡²"],
        icon: "https://flagicons.lipis.dev/flags/4x3/mm.svg",
        enabled: false
    },
    {
        name: "è€æŒ",
        keywords: ["è€æŒ", "LA", "Laos", "ğŸ‡±ğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/la.svg",
        enabled: false
    },
    {
        name: "å°åº¦",
        keywords: ["å°åº¦", "IN", "India", "ğŸ‡®ğŸ‡³"],
        icon: "https://flagicons.lipis.dev/flags/4x3/in.svg",
        enabled: false
    },
    {
        name: "å­ŸåŠ æ‹‰",
        keywords: ["å­ŸåŠ æ‹‰", "BD", "Bangladesh", "ğŸ‡§ğŸ‡©"],
        icon: "https://flagicons.lipis.dev/flags/4x3/bd.svg",
        enabled: false
    },
    {
        name: "å·´åŸºæ–¯å¦",
        keywords: ["å·´åŸºæ–¯å¦", "PK", "Pakistan", "ğŸ‡µğŸ‡°"],
        icon: "https://flagicons.lipis.dev/flags/4x3/pk.svg",
        enabled: false
    },
    {
        name: "å°¼æ³Šå°”",
        keywords: ["å°¼æ³Šå°”", "NP", "Nepal", "ğŸ‡³ğŸ‡µ"],
        icon: "https://flagicons.lipis.dev/flags/4x3/np.svg",
        enabled: false
    },
    {
        name: "æ–¯é‡Œå…°å¡",
        keywords: ["æ–¯é‡Œå…°å¡", "LK", "Sri Lanka", "ğŸ‡±ğŸ‡°"],
        icon: "https://flagicons.lipis.dev/flags/4x3/lk.svg",
        enabled: false
    },
    {
        name: "ä¿„ç½—æ–¯",
        keywords: ["ä¿„ç½—æ–¯", "RU", "Russia", "ğŸ‡·ğŸ‡º"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ru.svg",
        enabled: false
    },
    {
        name: "å“ˆè¨å…‹æ–¯å¦",
        keywords: ["å“ˆè¨å…‹æ–¯å¦", "KZ", "Kazakhstan", "ğŸ‡°ğŸ‡¿"],
        icon: "https://flagicons.lipis.dev/flags/4x3/kz.svg",
        enabled: false
    },
    {
        name: "å‰å°”å‰æ–¯æ–¯å¦",
        keywords: ["å‰å°”å‰æ–¯æ–¯å¦", "KG", "Kyrgyzstan", "ğŸ‡°ğŸ‡¬"],
        icon: "https://flagicons.lipis.dev/flags/4x3/kg.svg",
        enabled: false
    },
    {
        name: "ä¹Œå…¹åˆ«å…‹æ–¯å¦",
        keywords: ["ä¹Œå…¹åˆ«å…‹æ–¯å¦", "UZ", "Uzbekistan", "ğŸ‡ºğŸ‡¿"],
        icon: "https://flagicons.lipis.dev/flags/4x3/uz.svg",
        enabled: false
    },
    {
        name: "åœŸè€³å…¶",
        keywords: ["åœŸè€³å…¶", "TR", "Turkey", "ğŸ‡¹ğŸ‡·"],
        icon: "https://flagicons.lipis.dev/flags/4x3/tr.svg",
        enabled: false
    },
    {
        name: "æ²™ç‰¹é˜¿æ‹‰ä¼¯",
        keywords: ["æ²™ç‰¹é˜¿æ‹‰ä¼¯", "SA", "Saudi Arabia", "ğŸ‡¸ğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/sa.svg",
        enabled: false
    },
    {
        name: "é˜¿è”é…‹",
        keywords: ["é˜¿è”é…‹", "AE", "United Arab Emirates", "ğŸ‡¦ğŸ‡ª"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ae.svg",
        enabled: false
    },
    {
        name: "å¡å¡”å°”",
        keywords: ["å¡å¡”å°”", "QA", "Qatar", "ğŸ‡¶ğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/qa.svg",
        enabled: false
    },
    {
        name: "ä»¥è‰²åˆ—",
        keywords: ["ä»¥è‰²åˆ—", "IL", "Israel", "ğŸ‡®ğŸ‡±"],
        icon: "https://flagicons.lipis.dev/flags/4x3/il.svg",
        enabled: false
    },
    {
        name: "åŸƒåŠ",
        keywords: ["åŸƒåŠ", "EG", "Egypt", "ğŸ‡ªğŸ‡¬"],
        icon: "https://flagicons.lipis.dev/flags/4x3/eg.svg",
        enabled: false
    },
    {
        name: "å¸Œè…Š",
        keywords: ["å¸Œè…Š", "GR", "Greece", "ğŸ‡¬ğŸ‡·"],
        icon: "https://flagicons.lipis.dev/flags/4x3/gr.svg",
        enabled: false
    },
    {
        name: "æ„å¤§åˆ©",
        keywords: ["æ„å¤§åˆ©", "IT", "Italy", "ğŸ‡®ğŸ‡¹"],
        icon: "https://flagicons.lipis.dev/flags/4x3/it.svg",
        enabled: false
    },
    {
        name: "å¾·å›½",
        keywords: ["å¾·å›½", "DE", "Germany", "ğŸ‡©ğŸ‡ª"],
        icon: "https://flagicons.lipis.dev/flags/4x3/de.svg",
        enabled: false
    },
    {
        name: "æ³•å›½",
        keywords: ["æ³•å›½", "FR", "France", "ğŸ‡«ğŸ‡·"],
        icon: "https://flagicons.lipis.dev/flags/4x3/fr.svg",
        enabled: false
    },
    {
        name: "è‹±å›½",
        keywords: ["è‹±å›½", "UK", "ğŸ‡¬ğŸ‡§", "United Kingdom"],
        icon: "https://flagicons.lipis.dev/flags/4x3/gb.svg",
        enabled: false
    },
    {
        name: "è·å…°",
        keywords: ["è·å…°", "NL", "Netherlands", "c7s5", "ğŸ‡³ğŸ‡±"],
        icon: "https://flagicons.lipis.dev/flags/4x3/nl.svg",
        enabled: true
    },
    {
        name: "æ¯”åˆ©æ—¶",
        keywords: ["æ¯”åˆ©æ—¶", "BE", "Belgium", "ğŸ‡§ğŸ‡ª"],
        icon: "https://flagicons.lipis.dev/flags/4x3/be.svg",
        enabled: false
    },
    {
        name: "ç‘å£«",
        keywords: ["ç‘å£«", "CH", "Switzerland", "ğŸ‡¨ğŸ‡­"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ch.svg",
        enabled: false
    },
    {
        name: "ç‘å…¸",
        keywords: ["ç‘å…¸", "SE", "Sweden", "ğŸ‡¸ğŸ‡ª"],
        icon: "https://flagicons.lipis.dev/flags/4x3/se.svg",
        enabled: false
    },
    {
        name: "ä¸¹éº¦",
        keywords: ["ä¸¹éº¦", "DK", "Denmark", "ğŸ‡©ğŸ‡°"],
        icon: "https://flagicons.lipis.dev/flags/4x3/dk.svg",
        enabled: false
    },
    {
        name: "æŒªå¨",
        keywords: ["æŒªå¨", "NO", "Norway", "ğŸ‡³ğŸ‡´"],
        icon: "https://flagicons.lipis.dev/flags/4x3/no.svg",
        enabled: false
    },
    {
        name: "èŠ¬å…°",
        keywords: ["èŠ¬å…°", "FI", "Finland", "ğŸ‡«ğŸ‡®"],
        icon: "https://flagicons.lipis.dev/flags/4x3/fi.svg",
        enabled: false
    },
    {
        name: "æ³¢å…°",
        keywords: ["æ³¢å…°", "PL", "Poland", "ğŸ‡µğŸ‡±"],
        icon: "https://flagicons.lipis.dev/flags/4x3/pl.svg",
        enabled: false
    },
    {
        name: "æ·å…‹",
        keywords: ["æ·å…‹", "CZ", "Czech Republic", "ğŸ‡¨ğŸ‡¿"],
        icon: "https://flagicons.lipis.dev/flags/4x3/cz.svg",
        enabled: false
    },
    {
        name: "åŒˆç‰™åˆ©",
        keywords: ["åŒˆç‰™åˆ©", "HU", "Hungary", "ğŸ‡­ğŸ‡º"],
        icon: "https://flagicons.lipis.dev/flags/4x3/hu.svg",
        enabled: false
    },
    {
        name: "å¥¥åœ°åˆ©",
        keywords: ["å¥¥åœ°åˆ©", "AT", "Austria", "ğŸ‡¦ğŸ‡¹"],
        icon: "https://flagicons.lipis.dev/flags/4x3/at.svg",
        enabled: false
    },
    {
        name: "è¥¿ç­ç‰™",
        keywords: ["è¥¿ç­ç‰™", "ES", "Spain", "ğŸ‡ªğŸ‡¸"],
        icon: "https://flagicons.lipis.dev/flags/4x3/es.svg",
        enabled: false
    },
    {
        name: "è‘¡è„ç‰™",
        keywords: ["è‘¡è„ç‰™", "PT", "Portugal", "ğŸ‡µğŸ‡¹"],
        icon: "https://flagicons.lipis.dev/flags/4x3/pt.svg",
        enabled: false
    },
    {
        name: "çˆ±å°”å…°",
        keywords: ["çˆ±å°”å…°", "IE", "Ireland", "ğŸ‡®ğŸ‡ª"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ie.svg",
        enabled: false
    },
    {
        name: "å†°å²›",
        keywords: ["å†°å²›", "IS", "Iceland", "ğŸ‡®ğŸ‡¸"],
        icon: "https://flagicons.lipis.dev/flags/4x3/is.svg",
        enabled: false
    },
    {
        name: "ä¹Œå…‹å…°",
        keywords: ["ä¹Œå…‹å…°", "UA", "Ukraine", "ğŸ‡ºğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ua.svg",
        enabled: false
    },
    {
        name: "ç™½ä¿„ç½—æ–¯",
        keywords: ["ç™½ä¿„ç½—æ–¯", "BY", "Belarus", "ğŸ‡§ğŸ‡¾"],
        icon: "https://flagicons.lipis.dev/flags/4x3/by.svg",
        enabled: false
    },
    {
        name: "ç«‹é™¶å®›",
        keywords: ["ç«‹é™¶å®›", "LT", "Lithuania", "ğŸ‡±ğŸ‡¹"],
        icon: "https://flagicons.lipis.dev/flags/4x3/lt.svg",
        enabled: false
    },
    {
        name: "æ‹‰è„±ç»´äºš",
        keywords: ["æ‹‰è„±ç»´äºš", "LV", "Latvia", "ğŸ‡±ğŸ‡»"],
        icon: "https://flagicons.lipis.dev/flags/4x3/lv.svg",
        enabled: false
    },
    {
        name: "çˆ±æ²™å°¼äºš",
        keywords: ["çˆ±æ²™å°¼äºš", "EE", "Estonia", "ğŸ‡ªğŸ‡ª"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ee.svg",
        enabled: false
    },
    {
        name: "æ‘©å°”å¤šç“¦",
        keywords: ["æ‘©å°”å¤šç“¦", "MD", "Moldova", "ğŸ‡²ğŸ‡©"],
        icon: "https://flagicons.lipis.dev/flags/4x3/md.svg",
        enabled: false
    },
    {
        name: "ç½—é©¬å°¼äºš",
        keywords: ["ç½—é©¬å°¼äºš", "RO", "Romania", "ğŸ‡·ğŸ‡´"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ro.svg",
        enabled: false
    },
    {
        name: "ä¿åŠ åˆ©äºš",
        keywords: ["ä¿åŠ åˆ©äºš", "BG", "Bulgaria", "ğŸ‡§ğŸ‡¬"],
        icon: "https://flagicons.lipis.dev/flags/4x3/bg.svg",
        enabled: false
    },
    {
        name: "å¡å°”ç»´äºš",
        keywords: ["å¡å°”ç»´äºš", "RS", "Serbia", "ğŸ‡·ğŸ‡¸"],
        icon: "https://flagicons.lipis.dev/flags/4x3/rs.svg",
        enabled: false
    },
    {
        name: "å…‹ç½—åœ°äºš",
        keywords: ["å…‹ç½—åœ°äºš", "HR", "Croatia", "ğŸ‡­ğŸ‡·"],
        icon: "https://flagicons.lipis.dev/flags/4x3/hr.svg",
        enabled: false
    },
    {
        name: "æ–¯æ´›ä¼å…‹",
        keywords: ["æ–¯æ´›ä¼å…‹", "SK", "Slovakia", "ğŸ‡¸ğŸ‡°"],
        icon: "https://flagicons.lipis.dev/flags/4x3/sk.svg",
        enabled: false
    },
    {
        name: "æ³¢é»‘",
        keywords: ["æ³¢é»‘", "BA", "Bosnia and Herzegovina", "ğŸ‡§ğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ba.svg",
        enabled: false
    },
    {
        name: "åŠ æ‹¿å¤§",
        keywords: ["åŠ æ‹¿å¤§", "CA", "Canada", "ğŸ‡¨ğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ca.svg",
        enabled: false
    },
    {
        name: "å¢¨è¥¿å“¥",
        keywords: ["å¢¨è¥¿å“¥", "MX", "Mexico", "ğŸ‡²ğŸ‡½"],
        icon: "https://flagicons.lipis.dev/flags/4x3/mx.svg",
        enabled: false
    },
    {
        name: "å·´è¥¿",
        keywords: ["å·´è¥¿", "BR", "Brazil", "ğŸ‡§ğŸ‡·"],
        icon: "https://flagicons.lipis.dev/flags/4x3/br.svg",
        enabled: false
    },
    {
        name: "å“¥ä¼¦æ¯”äºš",
        keywords: ["å“¥ä¼¦æ¯”äºš", "CO", "Colombia", "ğŸ‡¨ğŸ‡´"],
        icon: "https://flagicons.lipis.dev/flags/4x3/co.svg",
        enabled: false
    },
    {
        name: "ç§˜é²",
        keywords: ["ç§˜é²", "PE", "Peru", "ğŸ‡µğŸ‡ª"],
        icon: "https://flagicons.lipis.dev/flags/4x3/pe.svg",
        enabled: false
    },
    {
        name: "é˜¿æ ¹å»·",
        keywords: ["é˜¿æ ¹å»·", "AR", "Argentina", "ğŸ‡¦ğŸ‡·"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ar.svg",
        enabled: false
    },
    {
        name: "å—é",
        keywords: ["å—é", "ZA", "South Africa", "ğŸ‡¿ğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/za.svg",
        enabled: false
    },
    {
        name: "æ¾³å¤§åˆ©äºš",
        keywords: ["æ¾³å¤§åˆ©äºš", "AU", "Australia", "ğŸ‡¦ğŸ‡º"],
        icon: "https://flagicons.lipis.dev/flags/4x3/au.svg",
        enabled: false
    },
    {
        name: "æ–°è¥¿å…°",
        keywords: ["æ–°è¥¿å…°", "NZ", "New Zealand", "ğŸ‡³ğŸ‡¿"],
        icon: "https://flagicons.lipis.dev/flags/4x3/nz.svg",
        enabled: false
    },
    {
        name: "å°¼æ—¥åˆ©äºš",
        keywords: ["å°¼æ—¥åˆ©äºš", "NG", "NGR", "Niger", "ğŸ‡³ğŸ‡¬"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ng.svg",
        enabled: true
    },
    {
        name: "å®‰å“¥æ‹‰",
        keywords: ["å®‰å“¥æ‹‰", "AO", "Angola", "ğŸ‡¦ğŸ‡´"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ao.svg",
        enabled: false
    },
    {
        name: "æ´¥å·´å¸ƒéŸ¦",
        keywords: ["æ´¥å·´å¸ƒéŸ¦", "ZW", "Zimbabwe", "ğŸ‡¿ğŸ‡¼"],
        icon: "https://flagicons.lipis.dev/flags/4x3/zw.svg",
        enabled: false
    },
    {
        name: "æ‘©æ´›å“¥",
        keywords: ["æ‘©æ´›å“¥", "MA", "Morocco", "ğŸ‡²ğŸ‡¦"],
        icon: "https://flagicons.lipis.dev/flags/4x3/ma.svg",
        enabled: false
    },
    {
        name: "çªå°¼æ–¯",
        keywords: ["çªå°¼æ–¯", "TN", "Tunisia", "ğŸ‡¹ğŸ‡³"],
        icon: "https://flagicons.lipis.dev/flags/4x3/tn.svg",
        enabled: false
    },
    {
        name: "é˜¿å¡æ‹œç–†",
        keywords: ["é˜¿å¡æ‹œç–†", "AZ", "Azerbaijan", "ğŸ‡¦ğŸ‡¿"],
        icon: "https://flagicons.lipis.dev/flags/4x3/az.svg",
        enabled: false
    },
    {
        name: "ä¼Šæ‹‰å…‹",
        keywords: ["ä¼Šæ‹‰å…‹", "IQ", "Iraq", "ğŸ‡®ğŸ‡¶"],
        icon: "https://flagicons.lipis.dev/flags/4x3/iq.svg",
        enabled: false
    },
    {
        name: "é˜¿å¯Œæ±—",
        keywords: ["é˜¿å¯Œæ±—", "AF", "Afghanistan", "ğŸ‡¦ğŸ‡«"],
        icon: "https://flagicons.lipis.dev/flags/4x3/af.svg",
        enabled: false
    },
    {
        name: "è’™å¤",
        keywords: ["è’™å¤", "MN", "Mongolia", "ğŸ‡²ğŸ‡³"],
        icon: "https://flagicons.lipis.dev/flags/4x3/mn.svg",
        enabled: false
    },
    {
        name: "é˜¿æ›¼",
        keywords: ["é˜¿æ›¼", "OM", "Oman", "ğŸ‡´ğŸ‡²"],
        icon: "https://flagicons.lipis.dev/flags/4x3/om.svg",
        enabled: false
    }
    {
        name: "Download",
        keywords: ["c7s801"],
        icon: "https://flagicons.lipis.dev/flags/4x3/om.svg",
        enabled: true
    }
];

/**
 * ä»£ç†è§„åˆ™é…ç½®
 * name: è§„åˆ™åç§°
 * gfw: æ˜¯å¦è¢«å¢™ (true=é»˜è®¤èµ°ä»£ç†, false=é»˜è®¤ç›´è¿)
 * urls: è§„åˆ™é›†é“¾æ¥ï¼Œå¯ä»¥æ˜¯å•ä¸ªURLæˆ–URLæ•°ç»„
 * payload: è‡ªå®šä¹‰è§„åˆ™å†…å®¹ï¼Œè®¾ç½®åurlså°†è¢«å¿½ç•¥
 * extraProxies: é¢å¤–æ·»åŠ åˆ°æ­¤è§„åˆ™ç»„çš„ä»£ç†ï¼Œä¾‹å¦‚REJECTç”¨äºå¹¿å‘Šæ‹¦æˆª
 */
const PROXY_RULES = [
    // Ads
    {
        name: "Ads", // è§„åˆ™åç§°
        gfw: false,       // ä¸è¢«å¢™ï¼Œé»˜è®¤ä¸èµ°ä»£ç†
        extraProxies: "REJECT", // é¢å¤–ä»£ç†ä¸ºREJECTï¼Œå³æ‹’ç»è¿æ¥
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/AdvertisingLite/AdvertisingLite_Classical.yaml", // è§„åˆ™é›†URL
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Reject.png"  // è§„åˆ™å›¾æ ‡URL
    },

    // è‡ªå®šä¹‰è§„åˆ™ç¤ºä¾‹
    {
        name: "Linux.do",
        gfw: false,
        payload: "DOMAIN-SUFFIX,linux.do", // è‡ªå®šä¹‰è§„åˆ™å†…å®¹ï¼ŒåŒ¹é…linux.doåŠå…¶å­åŸŸå
        icon: "https://linux.do/uploads/default/original/3X/9/d/9dd49731091ce8656e94433a26a3ef36062b3994.png"
    },

    // å¸¸ç”¨ç½‘ç«™åˆ†ç»„
    {
        name: "GitHub",
        gfw: false,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/GitHub/GitHub.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/GitHub.png"
    },
    {
        name: "Cloudflare",
        gfw: false,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Cloudflare/Cloudflare_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cloudflare.png"
    },
    {
        name: "Microsoft",
        gfw: false,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Microsoft/Microsoft_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Microsoft.png"
    },
    {
        name: "OneDrive",
        gfw: false,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/OneDrive/OneDrive_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/OneDrive.png"
    },
    {
        name: "Google",
        gfw: true,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Google/Google_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Google_Search.png"
    },
    {
        name: "YouTube",
        gfw: true,
        urls: [
            "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/YouTube/YouTube.yaml",
            "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/YouTubeMusic/YouTubeMusic.yaml"
        ],
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/YouTube.png"
    },
    {
        name: "OpenAi",
        gfw: true,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/OpenAI/OpenAI_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/ChatGPT.png"
    },
    {
        name: "Anthropic",
        gfw: true,
        urls: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/classical/anthropic.yaml",
        icon: "https://images.seeklogo.com/logo-png/51/1/anthropic-icon-logo-png_seeklogo-515014.png"
    },
    {
        name: "Spotify",
        gfw: true,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Spotify/Spotify.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Spotify.png",
    },
    {
        name: "TikTok",
        gfw: true,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/TikTok/TikTok_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/TikTok.png"
    },
    {
        name: "Twitter",
        gfw: true,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Twitter/Twitter_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Twitter.png"
    },
    {
        name: "Facebook",
        gfw: true,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Facebook/Facebook_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Facebook.png"
    },
    {
        name: "Steam",
        gfw: false,
        urls: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@release/rule/Clash/Steam/Steam_No_Resolve.yaml",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png"
    },
    // åœ¨æ­¤æ·»åŠ æ›´å¤šè§„åˆ™...
];

/**
 * è‡ªå®šä¹‰ä»£ç†ç»„åœ¨ Clash é¢æ¿ä¸­çš„æ˜¾ç¤ºé¡ºåº
 * åŒ…å«æ‰€æœ‰åŸºç¡€ç»„ã€PROXY_RULES ä¸­çš„ç»„ä»¥åŠå¯ç”¨çš„åœ°åŒºåˆ†ç»„ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
 * æŒ‰æ­¤æ•°ç»„çš„é¡ºåºæ’åˆ—ï¼Œæœªåˆ—å‡ºçš„ç»„å°†æŒ‰é»˜è®¤é¡ºåºè¿½åŠ åˆ°æœ«å°¾
 */
const PROXY_GROUP_ORDER = [
    "Proxy",
    "World",
    "Outside",
    "Ads",
    "Linux.do",
    "YouTube",	
    "OpenAi",
    "Anthropic",
    "Microsoft",
    "Google",		
	  "Spotify",		   
    "Steam",
    "GitHub",
    "Cloudflare",
    "OneDrive",
    "TikTok",
    "Twitter",
    "Facebook",
    "Auto",
    "Feedback",	
    "China",
    // ä»¥ä¸‹ä¸ºå¯ç”¨çš„åœ°åŒºåˆ†ç»„ï¼ˆè‡ªåŠ¨é€‰ä¼˜å’Œè´Ÿè½½å‡è¡¡ï¼‰
    "é¦™æ¸¯-è‡ªåŠ¨é€‰ä¼˜",
    "é¦™æ¸¯-è´Ÿè½½å‡è¡¡",
    "å°æ¹¾-è‡ªåŠ¨é€‰ä¼˜",
    "å°æ¹¾-è´Ÿè½½å‡è¡¡",
    "æ—¥æœ¬-è‡ªåŠ¨é€‰ä¼˜",
    "æ—¥æœ¬-è´Ÿè½½å‡è¡¡",
    "éŸ©å›½-è‡ªåŠ¨é€‰ä¼˜",
    "éŸ©å›½-è´Ÿè½½å‡è¡¡",
    "ç¾å›½-è‡ªåŠ¨é€‰ä¼˜",
    "ç¾å›½-è´Ÿè½½å‡è¡¡",	
    "è¶Šå—-è‡ªåŠ¨é€‰ä¼˜",
    "è¶Šå—-è´Ÿè½½å‡è¡¡",
    "æ³°å›½-è‡ªåŠ¨é€‰ä¼˜",
    "æ³°å›½-è´Ÿè½½å‡è¡¡",
    "è²å¾‹å®¾-è‡ªåŠ¨é€‰ä¼˜",
    "è²å¾‹å®¾-è´Ÿè½½å‡è¡¡",
    "é©¬æ¥è¥¿äºš-è‡ªåŠ¨é€‰ä¼˜",
    "é©¬æ¥è¥¿äºš-è´Ÿè½½å‡è¡¡",
    "æ–°åŠ å¡-è‡ªåŠ¨é€‰ä¼˜",
    "æ–°åŠ å¡-è´Ÿè½½å‡è¡¡",
    "æŸ¬åŸ”å¯¨-è‡ªåŠ¨é€‰ä¼˜",
    "æŸ¬åŸ”å¯¨-è´Ÿè½½å‡è¡¡",
    "å°åº¦å°¼è¥¿äºš-è‡ªåŠ¨é€‰ä¼˜",
    "å°åº¦å°¼è¥¿äºš-è´Ÿè½½å‡è¡¡",
    "ç¼…ç”¸-è‡ªåŠ¨é€‰ä¼˜",
    "ç¼…ç”¸-è´Ÿè½½å‡è¡¡",
    "è€æŒ-è‡ªåŠ¨é€‰ä¼˜",
    "è€æŒ-è´Ÿè½½å‡è¡¡",
    "å°åº¦-è‡ªåŠ¨é€‰ä¼˜",
    "å°åº¦-è´Ÿè½½å‡è¡¡",
    "å­ŸåŠ æ‹‰-è‡ªåŠ¨é€‰ä¼˜",
    "å­ŸåŠ æ‹‰-è´Ÿè½½å‡è¡¡",
    "å·´åŸºæ–¯å¦-è‡ªåŠ¨é€‰ä¼˜",
    "å·´åŸºæ–¯å¦-è´Ÿè½½å‡è¡¡",
    "ä¿„ç½—æ–¯-è‡ªåŠ¨é€‰ä¼˜",
    "ä¿„ç½—æ–¯-è´Ÿè½½å‡è¡¡",
    "å°¼æ—¥åˆ©äºš-è‡ªåŠ¨é€‰ä¼˜",
    "å°¼æ—¥åˆ©äºš-è´Ÿè½½å‡è¡¡"
];

/**
 * DNS é…ç½®
 * å¯æ ¹æ®éœ€è¦ä¿®æ”¹DNSæœåŠ¡å™¨
 */
const DNS_CONFIG = {
    // å›½é™…å¯ä¿¡DNS (åŠ å¯†)
    trustDnsList: [
        "tls://8.8.8.8", "tls://1.1.1.1", "tls://9.9.9.9", // ä½¿ç”¨TLSåŠ å¯†çš„Google DNS, Cloudflare DNS, Quad9 DNS
        "https://8.8.8.8/dns-query", "https://1.1.1.1/dns-query" // ä½¿ç”¨HTTPSåŠ å¯†çš„Google DNS, Cloudflare DNS
    ],

    // ç”¨äºè§£æåŸŸåæœåŠ¡å™¨çš„é»˜è®¤DNSï¼ˆå¿…é¡»ä¸ºIPï¼Œå¯åŠ å¯†ï¼‰
    defaultDNS: ["tls://1.12.12.12", "tls://223.5.5.5"], // é»˜è®¤DNSæœåŠ¡å™¨ï¼Œç”¨äºè§£æå…¶ä»–DNSæœåŠ¡å™¨çš„åŸŸåï¼Œä½¿ç”¨TLSåŠ å¯†

    // ä¸­å›½å¤§é™†DNSæœåŠ¡å™¨
    cnDnsList: [
        '119.29.29.29',                    // Tencent Dnspod
        '223.5.5.5',                       // Ali DNS
    ],

    // DNSéšç§ä¿æŠ¤è¿‡æ»¤å™¨
    fakeIpFilter: [
        "+.lan", "+.local", // è¿‡æ»¤æœ¬åœ°å±€åŸŸç½‘åŸŸå
        // Windowsç½‘ç»œè¿æ¥æ£€æµ‹
        "+.msftconnecttest.com", "+.msftncsi.com", // è¿‡æ»¤Windowsç½‘ç»œè¿æ¥æµ‹è¯•åŸŸå
        // QQ/å¾®ä¿¡å¿«é€Ÿç™»å½•æ£€æµ‹
        "localhost.ptlogin2.qq.com", "localhost.sec.qq.com",
        "localhost.work.weixin.qq.com",
    ],

    // æŒ‡å®šåŸŸåä½¿ç”¨çš„DNSæœåŠ¡å™¨
    // æ ¼å¼: "åŸŸåæˆ–geosite": DNSæœåŠ¡å™¨
    nameserverPolicy: {
        "geosite:private": "system", // åŒ¹é…æœ¬åœ°ç§æœ‰åŸŸåï¼Œä½¿ç”¨ç³»ç»ŸDNSæœåŠ¡å™¨
        "geosite:cn,steam@cn,category-games@cn,microsoft@cn,apple@cn": 'cnDnsList' // åŒ¹é…ä¸­å›½å¤§é™†ç½‘ç«™ã€Steamã€æ¸¸æˆåˆ†ç±»ã€å¾®è½¯ã€è‹¹æœç›¸å…³åŸŸåï¼Œä½¿ç”¨ä¸­å›½å¤§é™†DNSæœåŠ¡å™¨
    },

    // éœ€è¦æŒ‡å®šä½¿ç”¨å›½å¤–DNSçš„åŸŸå
    fallbackDomains: [
        "+.azure.com", "+.bing.com", "+.bingapis.com",
        "+.cloudflare.net", "+.docker.com", "+.docker.io",
        "+.facebook.com", "+.github.com", "+.githubusercontent.com",
        "+.google.com", "+.gstatic.com", "+.google.dev",
        "+.googleapis.cn", "+.googleapis.com", "+.googlevideo.com",
        "+.instagram.com", "+.meta.ai", "+.microsoft.com",
        "+.microsoftapp.net", "+.msn.com", "+.openai.com",
        "+.poe.com", "+.t.me", "+.twitter.com",
        "+.x.com", "+.youtube.com"
    ]
};

// ==================== ç³»ç»Ÿå®ç°åŒºï¼ˆä¸€èˆ¬ä¸éœ€è¦ä¿®æ”¹ï¼‰ ====================

// æ„å»ºDNSé…ç½®å¯¹è±¡
const dns = buildDnsConfig(DNS_CONFIG);

// ==================== è¾…åŠ©å‡½æ•°éƒ¨åˆ† ====================

/**
 * æ„å»ºDNSé…ç½®å¯¹è±¡
 * @param {Object} config - DNSé…ç½®å‚æ•°
 * @returns {Object} å®Œæ•´çš„DNSé…ç½®å¯¹è±¡
 */
function buildDnsConfig(config) {
    return {
        enable: true, // å¯ç”¨DNS
        listen: ":53", // ç›‘å¬ç«¯å£ä¸º53ï¼Œå³DNSé»˜è®¤ç«¯å£
        ipv6: true,     // å¯ç”¨IPv6
        "prefer-h3": true, // ä¸€ç§åŠ å¯†çš„åŸºäº QUIC åè®®å®ç°çš„DNS åè®®ï¼Œæ®è¯´æŸ¥è¯¢é€Ÿåº¦å¾ˆå¿«
        "use-hosts": true, // ä½¿ç”¨hostsæ–‡ä»¶
        "use-system-hosts": true, // ä½¿ç”¨ç³»ç»Ÿhostsæ–‡ä»¶
        "respect-rules": true, // éµå¾ªè§„åˆ™ä¸­æŒ‡å®šçš„DNSæœåŠ¡å™¨
        "enhanced-mode": "fake-ip", // ä½¿ç”¨Fake IPæ¨¡å¼ï¼Œæé«˜æ€§èƒ½å’Œéšç§æ€§
        "fake-ip-range": "198.18.0.1/16", // Fake IPåœ°å€èŒƒå›´
        "fake-ip-filter": config.fakeIpFilter, // Fake IPè¿‡æ»¤å™¨
        "default-nameserver": config.defaultDNS, // é»˜è®¤DNSæœåŠ¡å™¨,ç”¨äºè§£ænameserverä¸­çš„åŠ å¯† dns
        nameserver: config.trustDnsList,       // å¯ä¿¡DNSæœåŠ¡å™¨
        "proxy-server-nameserver": config.cnDnsList, // ä»£ç†æœåŠ¡å™¨ä½¿ç”¨çš„DNSæœåŠ¡å™¨
        "nameserver-policy": { // æŒ‡å®šåŸŸåæŸ¥è¯¢çš„è§£ææœåŠ¡å™¨ï¼Œå¯ä½¿ç”¨ geosite, ä¼˜å…ˆäº nameserver/fallback æŸ¥è¯¢
            "geosite:private": "system",
            "geosite:cn,steam@cn,category-games@cn,microsoft@cn,apple@cn": config.cnDnsList,
        },
        fallback: config.trustDnsList, // åå¤‡åŸŸåè§£ææœåŠ¡å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨å¢ƒå¤– DNS, ä¿è¯ç»“æœå¯ä¿¡é…ç½® fallbackåé»˜è®¤å¯ç”¨ fallback-filter,geoip-codeä¸º cn,è§£æå¢™å¤–åŸŸåçš„ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨å›½å†…DNSï¼Œæˆ‘è®¾ç½®ä¸ºå›½å¤–åŠ å¯† dns
        "fallback-filter": { // å›é€€è¿‡æ»¤å™¨ï¼ŒæŒ‡å®šå“ªäº›åŸŸåä½¿ç”¨å›é€€DNSæœåŠ¡å™¨
            geoip: true,
            "geoip-code": "CN",
            geosite: ["gfw"],
            ipcidr: ["240.0.0.0/4"],
            domain: config.fallbackDomains
        }
    };
}

/**
 * åˆ›å»ºè§„åˆ™æä¾›å™¨é…ç½® - ä½¿ç”¨å¯¹è±¡å¤ç”¨ä¼˜åŒ–æ€§èƒ½
 * @param {string} url - è§„åˆ™é›†URL
 * @returns {Object} è§„åˆ™æä¾›å™¨é…ç½®å¯¹è±¡
 */
function createRuleProviderUrl(url) {
    return {
        type: "http", // ç±»å‹ä¸ºHTTP
        interval: 86400, // æ›´æ–°é—´éš”ä¸º86400ç§’ï¼Œå³24å°æ—¶
        behavior: "classical", // è¡Œä¸ºä¸ºclassical
        format: "yaml",   // æ ¼å¼ä¸ºYAML
        url                 // è§„åˆ™é›†URL
    };
}

/**
 * åˆ›å»ºpayloadå¯¹åº”çš„è§„åˆ™ - ä¼˜åŒ–æ•°ç»„æ“ä½œ
 * @param {string|string[]} payload - è§„åˆ™å†…å®¹
 * @param {string} name - è§„åˆ™åç§°
 * @returns {string[]} å¤„ç†åçš„è§„åˆ™åˆ—è¡¨
 */
function createPayloadRules(payload, name) {
    const payloads = Array.isArray(payload) ? payload : [payload]; // ç¡®ä¿payloadæ˜¯æ•°ç»„
    const len = payloads.length;
    const rules = new Array(len);
    // ç›´æ¥è°ƒç”¨ replace è€Œé replaceAllï¼ˆå¤šæ•°ç¯å¢ƒä¸­æ•ˆæœç›¸ä¼¼ä¸”é«˜æ•ˆï¼‰
    const normalizedName = name.split(",").join("-"); // å°†è§„åˆ™åç§°ä¸­çš„é€—å·æ›¿æ¢ä¸ºçŸ­æ¨ªçº¿ï¼Œä»¥ä¾¿åœ¨Clashä¸­ä½¿ç”¨

    for (let i = 0; i < len; i++) {
        const item = payloads[i];
        const p = item.split(","); // å°†è§„åˆ™é¡¹æŒ‰é€—å·åˆ†å‰²æˆæ•°ç»„
        let insertPos = p.length;

        // æ¯”è¾ƒæ—¶é¿å…è½¬æ¢å¤§å°å†™
        const last = p[p.length - 1];
        if (last === "no-resolve" || last === "NO-RESOLVE") { // æ£€æŸ¥è§„åˆ™é¡¹æ˜¯å¦åŒ…å«no-resolve
            insertPos--; // å¦‚æœåŒ…å«ï¼Œåˆ™æ’å…¥ä½ç½®å‘å‰ç§»åŠ¨ä¸€ä½
        }

        p.splice(insertPos, 0, normalizedName); // åœ¨æŒ‡å®šä½ç½®æ’å…¥è§„åˆ™åç§°
        rules[i] = p.join(",");             // å°†æ•°ç»„é‡æ–°ç»„åˆæˆå­—ç¬¦ä¸²
    }

    return rules; // è¿”å›å¤„ç†åçš„è§„åˆ™åˆ—è¡¨
}

/**
 * åˆ›å»ºGFWï¼ˆè¢«å¢™ï¼‰ä»£ç†ç»„
 * @param {string} name - ä»£ç†ç»„åç§°
 * @param {string|string[]} addProxies - é¢å¤–ä»£ç†
 * @param {string} testUrl - æµ‹è¯•é“¾æ¥
 * @param {string} icon - ä»£ç†ç»„å›¾æ ‡
 * @param {string[]} regionGroupNames - æ‰€æœ‰åœ°åŒºçš„ä»£ç†ç»„åç§°
 * @returns {Object} ä»£ç†ç»„é…ç½®
 */
function createGfwProxyGroup(name, addProxies, testUrl, icon, regionGroupNames) {
    addProxies = addProxies ? (Array.isArray(addProxies) ? addProxies : [addProxies]) : []; // ç¡®ä¿addProxiesæ˜¯æ•°ç»„
    return {
        "name": name, // ä»£ç†ç»„åç§°
        "type": "select", // ä»£ç†ç»„ç±»å‹ä¸ºselectï¼Œå³æ‰‹åŠ¨é€‰æ‹©
        // ç¡®ä¿åŒ…å«æ‰€æœ‰åœ°åŒºåˆ†ç»„çš„ä¸¤ä¸ªç‰ˆæœ¬
        "proxies": ["æ¨¡å¼é€‰æ‹©", ...addProxies, ...regionGroupNames, "æ‰€æœ‰èŠ‚ç‚¹-è‡ªåŠ¨é€‰ä¼˜", "æ‰€æœ‰èŠ‚ç‚¹-è´Ÿè½½å‡è¡¡", "DIRECT"], // ä»£ç†æœåŠ¡å™¨åˆ—è¡¨ï¼ŒåŒ…å«æ¨¡å¼é€‰æ‹©ã€é¢å¤–ä»£ç†ã€åœ°åŒºåˆ†ç»„ã€è‡ªåŠ¨é€‰ä¼˜ã€è´Ÿè½½å‡è¡¡å’Œç›´è¿
        "include-all": true, // åŒ…å«æ‰€æœ‰ä»£ç†æœåŠ¡å™¨
        "url": testUrl,       // æµ‹è¯•URLï¼Œç”¨äºæ£€æµ‹ä»£ç†æœåŠ¡å™¨è¿é€šæ€§
        "icon": icon         // ä»£ç†ç»„å›¾æ ‡URL
    };
}

/**
 * åˆ›å»ºæ™®é€šï¼ˆéGFWï¼‰ä»£ç†ç»„
 * @param {string} name - ä»£ç†ç»„åç§°
 * @param {string|string[]} addProxies - é¢å¤–ä»£ç†
 * @param {string} testUrl - æµ‹è¯•é“¾æ¥
 * @param {string} icon - ä»£ç†ç»„å›¾æ ‡
 * @param {string[]} regionGroupNames - æ‰€æœ‰åœ°åŒºçš„ä»£ç†ç»„åç§°
 * @returns {Object} ä»£ç†ç»„é…ç½®
 */
function createProxyGroup(name, addProxies, testUrl, icon, regionGroupNames) {
    addProxies = addProxies ? (Array.isArray(addProxies) ? addProxies : [addProxies]) : [];
    return {
        "name": name,
        "type": "select",
        // ç¡®ä¿åŒ…å«æ‰€æœ‰åœ°åŒºåˆ†ç»„çš„ä¸¤ä¸ªç‰ˆæœ¬
        "proxies": ["æ¨¡å¼é€‰æ‹©", ...addProxies, ...regionGroupNames, "DIRECT", "æ‰€æœ‰èŠ‚ç‚¹-è‡ªåŠ¨é€‰ä¼˜", "æ‰€æœ‰èŠ‚ç‚¹-è´Ÿè½½å‡è¡¡"],
        "include-all": true,
        "url": testUrl,
        "icon": icon
    };
}

/**
 * æ„å»ºåŸºæœ¬ä»£ç†ç»„
 * @param {Array} proxies - æ‰€æœ‰ä»£ç†èŠ‚ç‚¹
 * @param {string} testUrl - æµ‹è¯•URL
 * @returns {Array} åŸºæœ¬ä»£ç†ç»„é…ç½®
 */
function buildBaseProxyGroups(proxies, testUrl) {
    // åŠ¨æ€ç­›é€‰å¯ç”¨ä¸”æœ‰å®é™…ä»£ç†èŠ‚ç‚¹çš„åœ°åŒº
    const availableRegions = REGIONS.filter(region => 
        region.enabled && 
        proxies.some(proxy => region.keywords.some(keyword => proxy.name.toLowerCase().includes(keyword.toLowerCase())))
    );

    // åˆ›å»ºåœ°åŒºåˆ†ç»„çš„è‡ªåŠ¨é€‰ä¼˜å’Œè´Ÿè½½å‡è¡¡ç‰ˆæœ¬
    const regionGroupsAutoSelect = availableRegions.map(region => {
        const regionProxies = proxies.filter(proxy =>
            region.keywords.some(keyword => proxy.name.toLowerCase().includes(keyword.toLowerCase()))
        ).map(proxy => proxy.name);
        return {
            name: `${region.name}-è‡ªåŠ¨é€‰ä¼˜`, // åœ°åŒºåç§°åŠ ä¸Šè‡ªåŠ¨é€‰ä¼˜åç¼€
            type: "url-test", // ä½¿ç”¨url-testæ¨¡å¼
            proxies: regionProxies, // åŒ…å«è¯¥åœ°åŒºçš„ä»£ç†æœåŠ¡å™¨
            url: testUrl,         // æµ‹è¯•URL
            interval: CONFIG.testInterval, // æµ‹è¯•é—´éš”
            icon: region.icon       // åœ°åŒºå›¾æ ‡
        };
    });

    const regionGroupsLoadBalance = availableRegions.map(region => {
        const regionProxies = proxies.filter(proxy =>
            region.keywords.some(keyword => proxy.name.toLowerCase().includes(keyword.toLowerCase()))
        ).map(proxy => proxy.name);
        return {
            name: `${region.name}-è´Ÿè½½å‡è¡¡`, // åœ°åŒºåç§°åŠ ä¸Šè´Ÿè½½å‡è¡¡åç¼€
            type: "load-balance", // ä½¿ç”¨load-balanceæ¨¡å¼
            proxies: regionProxies, // åŒ…å«è¯¥åœ°åŒºçš„ä»£ç†æœåŠ¡å™¨
            url: testUrl,         // æµ‹è¯•URL
            interval: CONFIG.testInterval, // æµ‹è¯•é—´éš”
            strategy: CONFIG.balanceStrategy, // ä½¿ç”¨é…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
            icon: region.icon       // åœ°åŒºå›¾æ ‡
        };
    });

    // åˆå¹¶ä¸¤ä¸ªç‰ˆæœ¬çš„åœ°åŒºåˆ†ç»„
    const regionGroups = [...regionGroupsAutoSelect, ...regionGroupsLoadBalance];

    // æŒ‰åœ°åŒºé¡ºåºç”Ÿæˆåœ°åŒºåˆ†ç»„åç§°ï¼Œæ¯å¯¹ä¸ºâ€œè‡ªåŠ¨é€‰ä¼˜â€å’Œâ€œè´Ÿè½½å‡è¡¡â€
    const regionGroupNames = availableRegions.map(region => [
        `${region.name}-è‡ªåŠ¨é€‰ä¼˜`,
        `${region.name}-è´Ÿè½½å‡è¡¡`
    ]).flat();

    // åˆ›å»ºâ€œæ¨¡å¼é€‰æ‹©â€ç»„ï¼Œç¡®ä¿å³ä½¿ regionGroupNames ä¸ºç©ºï¼Œä¹Ÿæœ‰é»˜è®¤é€‰é¡¹
    const areaSelectGroup = {
        name: "Proxy",
        type: "select",
        proxies: ["Auto", "Feedback", "DIRECT", ...regionGroupNames],
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png"
    };

    // å…¶ä»–åŸºæœ¬ä»£ç†ç»„
    const otherGroups = [
        {
            "name": "China",
            "type": "select",
            "proxies": ["DIRECT"],
            "include-all": true,
            "url": "https://www.baidu.com/favicon.ico",
            "icon": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/China.png"
        },
        {
            "name": "World",
            "type": "select",
            "proxies": ["Proxy", "DIRECT"],
            "include-all": true,
            "url": "https://www.bing.com/favicon.ico",
            "icon": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/United_Nations.png"
        },
        {
            "name": "Outside",
            "type": "select",
            "proxies": ["Proxy", "DIRECT"],
            "include-all": true,
            "url": testUrl,
            "icon": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Lock.png"
        },
        // è‡ªåŠ¨é€‰ä¼˜å’Œè´Ÿè½½å‡è¡¡
        {
            "name": "Auto",
            "type": "url-test",
            "tolerance": CONFIG.tolerance,
            "include-all": true,
            "url": testUrl,
            "interval": CONFIG.testInterval,
            "icon": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png"
        },
        {
            "name": "Feedback",
            "type": "load-balance",
            "include-all": true,
            "strategy": CONFIG.balanceStrategy,
            "url": testUrl,
            "interval": CONFIG.testInterval,
            "icon": "https://www.clashverge.dev/assets/icons/balance.svg"
        },
        ...regionGroups
    ];

    // å°†â€œæ¨¡å¼é€‰æ‹©â€ç»„æ”¾åœ¨æœ€å‰é¢
    return [areaSelectGroup, ...otherGroups];
}

/**
 * ä¸»å‡½æ•°ï¼šç”Ÿæˆå®Œæ•´çš„Clashé…ç½®
 * @param {Object} config - è¾“å…¥é…ç½®
 * @returns {Object} å®Œæ•´çš„Clashé…ç½®
 */
function main(config) {
    const { proxies } = config; // ä»è¾“å…¥é…ç½®ä¸­è·å–ä»£ç†æœåŠ¡å™¨åˆ—è¡¨
    const testUrl = CONFIG.testUrl; // è·å–å…¨å±€æµ‹è¯•URL

    // åˆå§‹åŒ–è§„åˆ™å’Œä»£ç†ç»„
    const rules = USER_RULES.slice(); // å¤åˆ¶ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ï¼Œé˜²æ­¢ä¿®æ”¹åŸå§‹æ•°ç»„
    const customProxyGroups = []; // å­˜å‚¨ PROXY_RULES ç”Ÿæˆçš„ä»£ç†ç»„

    // è§„åˆ™é›†é€šç”¨é…ç½®
    const ruleProviderCommon = {
        type: "http",
        format: "yaml",
        interval: 86400
    };

    // åˆå§‹åŒ–è§„åˆ™æä¾›å™¨
    const ruleProviders = {
        reject: {
            ...ruleProviderCommon,
            behavior: "domain",
            url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt",
            path: "./ruleset/loyalsoldier/reject.yaml"
        },
        cncidr: {
            ...ruleProviderCommon,
            behavior: "ipcidr",
            url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt",
            path: "./ruleset/loyalsoldier/cncidr.yaml"
        },
        direct: {
            ...ruleProviderCommon,
            behavior: "domain",
            url: "https://fastly.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt",
            path: "./ruleset/loyalsoldier/direct.yaml"
        }
    };

    // è·å–æ‰€æœ‰å¯ç”¨çš„åœ°åŒºçš„ä»£ç†ç»„åç§°
    const availableRegions = REGIONS.filter(region =>
        region.enabled && 
        proxies.some(proxy => region.keywords.some(keyword => proxy.name.toLowerCase().includes(keyword.toLowerCase())))
    );
    const regionGroupNames = availableRegions.map(region => [
        `${region.name}-è‡ªåŠ¨é€‰ä¼˜`,
        `${region.name}-è´Ÿè½½å‡è¡¡`
    ]).flat();

    // ç”Ÿæˆ PROXY_RULES çš„ä»£ç†ç»„
    PROXY_RULES.forEach(({ name, gfw, urls, payload, extraProxies, icon }) => { // éå†ä»£ç†è§„åˆ™é…ç½®
        let group;
        if (name === "Ads") {
            group = {
                "name": name,
                "type": "select",
                "proxies": [extraProxies],
                "include-all": false,
                "url": testUrl,
                "icon": icon
            };
        } else if (gfw) { // å¦‚æœæ˜¯GFWè§„åˆ™
            group = createGfwProxyGroup(name, extraProxies, testUrl, icon, regionGroupNames); // åˆ›å»ºGFWä»£ç†ç»„
        } else { // å¦‚æœæ˜¯éGFWè§„åˆ™
            group = createProxyGroup(name, extraProxies, testUrl, icon, regionGroupNames); // åˆ›å»ºæ™®é€šä»£ç†ç»„
        }
        customProxyGroups.push(group);

        if (payload) {
            rules.push(...createPayloadRules(payload, name)); // æ·»åŠ åˆ°è§„åˆ™åˆ—è¡¨
        } else if (urls) { // å¦‚æœæœ‰è§„åˆ™é›†URL
            const urlList = Array.isArray(urls) ? urls : [urls]; // ç¡®ä¿urlsæ˜¯æ•°ç»„
            urlList.forEach((theUrl, j) => {
                const iName = `${name}-rule${j !== 0 ? `-${j}` : ''}`; // ç”Ÿæˆå”¯ä¸€çš„è§„åˆ™æä¾›å™¨åç§°
                ruleProviders[iName] = createRuleProviderUrl(theUrl); // åˆ›å»ºè§„åˆ™æä¾›å™¨
                rules.push(`RULE-SET,${iName},${name}`); // æ·»åŠ è§„åˆ™é›†è§„åˆ™
            });
        }
    });

    // æ„å»ºåŸºæœ¬ä»£ç†ç»„
    const baseProxyGroups = buildBaseProxyGroups(proxies, testUrl);

    // åˆ›å»ºæ‰€æœ‰ä»£ç†ç»„çš„æ˜ å°„
    const allProxyGroupsMap = new Map();
    baseProxyGroups.forEach(group => allProxyGroupsMap.set(group.name, group));
    customProxyGroups.forEach(group => allProxyGroupsMap.set(group.name, group));

    // æ ¹æ® PROXY_GROUP_ORDER æ’åº
    const orderedProxyGroups = [];
    PROXY_GROUP_ORDER.forEach(name => {
        const group = allProxyGroupsMap.get(name);
        if (group) {
            orderedProxyGroups.push(group);
            allProxyGroupsMap.delete(name); // åˆ é™¤å·²æ·»åŠ çš„ç»„ï¼Œé¿å…é‡å¤
        }
    });

    // å°†å‰©ä½™æœªæ’åºçš„ç»„è¿½åŠ åˆ°æœ«å°¾
    const remainingGroups = Array.from(allProxyGroupsMap.values());
    const finalProxyGroups = [...orderedProxyGroups, ...remainingGroups];

    // æ„å»ºæœ€ç»ˆé…ç½®
    return {
        mode: "rule", // æ¨¡å¼ä¸ºè§„åˆ™æ¨¡å¼
        "find-process-mode": "strict",
        "global-client-fingerprint": "chrome",
        "unified-delay": true,
        "tcp-concurrent": true,
        "geox-url": {
            geoip: "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
            geosite: "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
        },
        dns, // ä½¿ç”¨ä¹‹å‰æ„å»ºçš„DNSé…ç½®
        proxies, // ä½¿ç”¨ä¼ å…¥çš„ä»£ç†æœåŠ¡å™¨åˆ—è¡¨
        "proxy-groups": finalProxyGroups,
        "rule-providers": ruleProviders, // ä½¿ç”¨ä¹‹å‰æ„å»ºçš„è§„åˆ™æä¾›å™¨
        rules: [
            ...rules,
            ...SAVED_RULES
        ]
    };
}
